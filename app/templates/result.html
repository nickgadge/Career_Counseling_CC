{% extends "base.html" %}
{% block content %}
<div class="container-fluid px-4">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Career Aptitude Result / करिअर अभिक्षमता निकाल</h2>
        <div class="d-flex gap-2">
          <a class="btn btn-outline-dark" href="{{ url_for('students.report_pdf') }}">
            <i class="fas fa-download me-1"></i> PDF
          </a>
          <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#emailModal">
            <i class="fas fa-envelope me-1"></i> Email
          </button>
        </div>
      </div>

      <!-- User Info Card -->
      <div class="card shadow-sm border-0">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-md-4 border-end">
              <div class="d-flex align-items-center">
                <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                  <i class="fas fa-user text-primary"></i>
                </div>
                <div>
                  <small class="text-muted">Name / नाव</small>
                  <p class="mb-0 fw-bold">{{ name }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-4 border-end">
              <div class="d-flex align-items-center">
                <div class="bg-success bg-opacity-10 p-3 rounded-circle me-3">
                  <i class="fas fa-phone text-success"></i>
                </div>
                <div>
                  <small class="text-muted">Phone / फोन</small>
                  <p class="mb-0 fw-bold">{{ phone }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex align-items-center">
                <div class="bg-info bg-opacity-10 p-3 rounded-circle me-3">
                  <i class="fas fa-map-marker-alt text-info"></i>
                </div>
                <div>
                  <small class="text-muted">Address / पत्ता</small>
                  <p class="mb-0 fw-bold">{{ address }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="row g-4 mb-4">
    <div class="col-xl-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-white py-3 border-0">
          <h5 class="card-title mb-0 d-flex align-items-center">
            <i class="fas fa-chart-bar text-primary me-2"></i>
            Category Scores (Bar) / श्रेणी गुण (स्तंभ)
          </h5>
        </div>
        <div class="card-body">
          <canvas id="barChart" height="300"></canvas>
        </div>
      </div>
    </div>
    <div class="col-xl-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-white py-3 border-0">
          <h5 class="card-title mb-0 d-flex align-items-center">
            <i class="fas fa-chart-radar text-danger me-2"></i>
            Profile Radar / प्रोफाइल रडार
          </h5>
        </div>
        <div class="card-body">
          <canvas id="radarChart" height="300"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Recommendations Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 border-0">
          <h5 class="card-title mb-0 d-flex align-items-center">
            <i class="fas fa-star text-warning me-2"></i>
            Top Recommendations / सर्वोत्तम शिफारसी
          </h5>
        </div>
        <div class="card-body">
          <div class="accordion" id="recommendationsAccordion">
            {% for rec in recommendations %}
            <div class="accordion-item border-0 mb-3">
              <h2 class="accordion-header" id="heading{{ loop.index }}">
                <button class="accordion-button {% if not loop.first %}collapsed{% endif %} shadow-none" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}"
                        aria-expanded="{% if loop.first %}true{% else %}false{% endif %}"
                        aria-controls="collapse{{ loop.index }}">
                  <span class="badge bg-success me-3">{{ rec.pct }}%</span>
                  <strong>{{ rec.cat_en }} ({{ rec.cat_mr }})</strong>
                </button>
              </h2>
              <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
                   aria-labelledby="heading{{ loop.index }}" data-bs-parent="#recommendationsAccordion">
                <div class="accordion-body pt-3">
                  <div class="row">
                    <div class="col-lg-6 mb-3 mb-lg-0">
                      <div class="card bg-light border-0 h-100">
                        <div class="card-header bg-light border-0">
                          <h6 class="mb-0"><i class="fas fa-list-ul text-primary me-2"></i>Suggested Fields (EN)</h6>
                        </div>
                        <div class="card-body">
                          <ul class="mb-0">
                            {% for f in rec.fields_en %}
                            <li>{{ f }}</li>
                            {% endfor %}
                          </ul>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-6">
                      <div class="card bg-light border-0 h-100">
                        <div class="card-header bg-light border-0">
                          <h6 class="mb-0"><i class="fas fa-list-ul text-primary me-2"></i>सुचवलेले पर्याय (MR)</h6>
                        </div>
                        <div class="card-body">
                          <ul class="mb-0">
                            {% for f in rec.fields_mr %}
                            <li>{{ f }}</li>
                            {% endfor %}
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>

                  {% if rec.links %}
                  <div class="mt-4">
                    <h6 class="d-flex align-items-center mb-3">
                      <i class="fas fa-link text-info me-2"></i>
                      Resources / स्रोत
                    </h6>
                    <div class="d-flex flex-wrap gap-2">
                      {% for link in rec.links %}
                      <a href="{{ link.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt me-1"></i>{{ link.name }}
                      </a>
                      {% endfor %}
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Card -->
  <div class="row">
    <div class="col-12">
      <div class="card bg-primary bg-opacity-5 border-0">
        <div class="card-body text-center p-4">
          <h4 class="mb-3">Congratulations on completing your assessment! / अभिनंदन, तुमचे मूल्यांकन पूर्ण झाले आहे!</h4>
          <p class="mb-0">Your unique strengths and interests have been identified. Explore the recommendations above to discover potential career paths that align with your abilities.</p>
          <p class="mb-0">तुमचे Unique सामर्थ्य आणि रुची ओळखल्या गेल्या आहेत. तुमच्या क्षमतांशी जुळणारे संभाव्य करिअर मार्ग शोधण्यासाठी वरील शिफारसी एक्सप्लोर करा.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Email Modal -->
<div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="emailModalLabel">Email Report to Parent</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{{ url_for('students.email_report') }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="parentEmail" class="form-label">Parent Email Address</label>
            <input type="email" class="form-control" id="parentEmail" name="parent_email" placeholder="Enter email address" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Send Email</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Chart.js & Confetti -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
  // Register the plugin to all charts
  Chart.register(ChartDataLabels);

  // Color palette
  const colors = [
    'rgba(54, 162, 235, 0.7)',   // Blue
    'rgba(255, 99, 132, 0.7)',   // Pink
    'rgba(75, 192, 192, 0.7)',   // Green
    'rgba(255, 159, 64, 0.7)',   // Orange
    'rgba(153, 102, 255, 0.7)',  // Purple
    'rgba(255, 205, 86, 0.7)',   // Yellow
    'rgba(201, 203, 207, 0.7)'   // Gray
  ];

  // Bar Chart
  const barChart = new Chart(document.getElementById('barChart'), {
    type: 'bar',
    data: {
      labels: {{ chart_labels|tojson }},
      datasets: [{
        label: 'Score (%)',
        data: {{ chart_data|tojson }},
        backgroundColor: colors,
        borderColor: colors.map(color => color.replace('0.7', '1')),
        borderWidth: 1,
        borderRadius: 4,
        hoverBackgroundColor: colors.map(color => color.replace('0.7', '0.9'))
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.7)',
          titleFont: { size: 14 },
          bodyFont: { size: 14 },
          padding: 10,
          cornerRadius: 4
        },
        datalabels: {
          color: '#343a40',
          anchor: 'end',
          align: 'top',
          font: {
            weight: 'bold',
            size: 11
          },
          formatter: (value) => value + '%'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          grid: { drawBorder: false },
          ticks: { padding: 10 }
        },
        x: {
          grid: { display: false }
        }
      }
    }
  });

  // Radar Chart
  const radarChart = new Chart(document.getElementById('radarChart'), {
    type: 'radar',
    data: {
      labels: {{ chart_labels|tojson }},
      datasets: [{
        label: 'Profile Score',
        data: {{ chart_data|tojson }},
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        borderColor: 'rgba(255, 99, 132, 0.8)',
        pointBackgroundColor: 'rgba(255, 99, 132, 1)',
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: 'rgba(255, 99, 132, 1)',
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.7)',
          titleFont: { size: 14 },
          bodyFont: { size: 14 },
          padding: 10,
          cornerRadius: 4
        }
      },
      scales: {
        r: {
          beginAtZero: true,
          max: 100,
          ticks: {
            stepSize: 20,
            backdropColor: 'transparent'
          },
          grid: { color: 'rgba(0, 0, 0, 0.1)' },
          angleLines: { color: 'rgba(0, 0, 0, 0.1)' },
          pointLabels: {
            font: {
              size: 11,
              weight: 'bold'
            }
          }
        }
      }
    }
  });

  // Confetti animation
  setTimeout(() => {
    confetti({
      particleCount: 150,
      spread: 100,
      origin: { y: 0.6 },
      colors: ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff']
    });
  }, 500);
</script>

<!-- Font Awesome for icons -->
<script src="https://kit.fontawesome.com/your-kit-id.js" crossorigin="anonymous"></script>
<style>
  body {
    background-color: #f8f9fa;
  }
  .card {
    border-radius: 12px;
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
  }
  .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.08) !important;
  }
  .accordion-button:not(.collapsed) {
    background-color: #f8f9fa;
    color: #0d6efd;
    box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.125);
  }
  .badge {
    font-size: 0.9em;
    padding: 0.5em 0.7em;
  }
</style>
{% endblock %}